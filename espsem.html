<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>surface semantique</title>
	<script src="jquery.js"></script>
	<link rel="stylesheet" type="text/css" href="style.css">
	<script type="text/javascript" src="paper-full.js"></script>
</head>
<body>
	<div id="lists">
		<div id="syns"> </div>
		<div id="cliques"></div>
	</div>
	<div id="ui">
		<div id="SelectXAxis">Axe Horizontal : 
			<select id="axe1">
  				<option value="0" selected>1</option> 
  				<option value="1">2</option>
  				<option value="2">3</option>
  				<option value="3">4</option> 
  				<option value="4">5</option>
  				<option value="5">6</option>
			</select> 
		</div>
		<div id="SelectYAxis">Axe Vertical :
			<select id="axe2">
  				<option value="0">1</option> 
  				<option value="1" selected>2</option>
  				<option value="2">3</option>
  				<option value="3">4</option> 
  				<option value="4">5</option>
  				<option value="5">6</option>
			</select>
		</div>
		<input id="word" type="text" value="bois">
		<button id="hidecli">cacher cliques</button>

	</div>
	<canvas id="canvas"></canvas>
	<script type="text/javascript">
	window.onload = function() {

		
		var canvas = document.getElementById('canvas');
		canvas.width  = window.innerWidth*0.75;
		canvas.height = window.innerHeight*0.85;
		paper.setup(canvas);
		paper.view.translate(paper.view.center);
		paper.view.onClick = function(event) {
			/*reflechir au zoom :
			utiliser le zoom de paper JS ?
				probleme : agrandit la vue, (càd les points etc...)
			creer une fonction de zoom, qui translate les coordonnées dans le plan ?
				seems better (y)
			*/
			if(event.target==paper.view){
				this.scale(1.25, event.point);
				for (var i = 0; i < paper.project.activeLayer.children.length; i++) {
					paper.project.activeLayer.children[i].scale(0.8);
				}
			}
    		

		}
		var cliques, syns, coords, cliVisible = true;
		var extremevalues = [0, 0, 0, 0, 0, 0];

		var axe1 = document.getElementById('axe1');
		var axe2 = document.getElementById('axe2');

		$('#axe1').change(function(){
			updateAxis();
		});
		$('#axe2').change(function(){
			updateAxis();
		});

		$('#hidecli').click(function(){
			if($('#hidecli').text() == "cacher cliques"){
				$('#hidecli').text("montrer cliques");
				cliVisible = false;
				for (var i = 0; i < cliques.length; i++) {
					cliques[i].circle.visible = false;
				}
			}else{
				$('#hidecli').text("cacher cliques");
				cliVisible = true;
				for (var i = 0; i < cliques.length; i++) {
					cliques[i].circle.visible = true;
				}
			}
		})


		$.ajax({
       		url : 'data',
       		type : 'GET',
       		dataType : 'text',
       		success : espsem,
			error : function(resultat, statut, erreur){
       		console.log("can't get data from serveur");
       		}
		});

		function updateAxis(){
			var x = $('#axe1').val();
			var y = $('#axe2').val();
			console.log(x, y);
			for (var i = 0; i < cliques.length; i++) {
				cliques[i].setAxis(x, y);
			}
			for (var i = 0; i < cliques.length; i++) {
				syns[i].setAxis(x, y);
			}

		}

		function Syn(asyn, i){

				this.index = i;
           		this.mot = asyn;
           		this.coords = coords[i + cliques.length];
           		this.cliques = [];
           		
           		
           		this.point = new paper.Point(0,0);
           		
           		//this.point.y = this.coords[1];
           		//this.point = centerandscale(this.point, xymax);
           		this.clicked=false;
				
           		this.text = new paper.PointText(new paper.Point(this.point.x - 1/paper.view.zoom, this.point.y - 1/paper.view.zoom));
           		this.text.visible = false;
				this.text.justification = 'center';
				this.text.fillColor = "magenta";
				this.text.fontSize = 15;
				this.text.content = this.mot;
				
				
				this.paths = [];
				this.circle = new paper.Path.Circle(this.point, 3);
           		this.circle.fillColor = "magenta";
           		this.linkPointText = new paper.Path.Line(this.circle.position, this.text.position);
				this.linkPointText.visible = false;
           		
				console.log(this.linkPointText);

           		this.text.onMouseDrag = function(event) {
					this.text.position.x += event.delta.x;
    				this.text.position.y += event.delta.y;
    				this.linkPointText.firstSegment.point = this.circle.position;
    				this.linkPointText.lastSegment.point = this.text.position;
    				this.linkPointText.strokeColor = 'black';
					this.linkPointText.strokeWidth = 1/paper.view.zoom;
					
    			}.bind(this);

				this.circle.onMouseEnter = function(event){
					
					this.linkPointText.visible = true;
					if(!this.clicked){
						this.text.visible = true;
						this.showcliques();
					}
				}.bind(this);
				this.circle.onClick = function(event){
					if(this.clicked){
						this.circle.fillColor = "magenta";
						this.text.fillColor = "magenta";
						this.clicked=false;
					}
					else{
						this.circle.fillColor = "green";
						this.text.fillColor = "green";
						this.clicked = true;
					}
				}.bind(this);

				this.circle.onMouseLeave = function(event){
					if(!this.clicked){
						this.linkPointText.visible = false;
						//this.linkPointText = null;
						this.circle.fillColor = "magenta";
						this.text.fillColor = 'magenta';
						this.text.visible = false;
						this.clearcliques();
					}
					
				}.bind(this);

				this.html = $("<div class='syn' id='" + this.i + "''>" + this.mot + "</div>").appendTo("#syns");
				this.html.click(function(){

					$("#cliques").html("");
					$("#cliques").append("cliques de " + this.mot + " :");
					//vrejbjvrehbvre
					for (var i = 0; i < this.cliques.length; i++) {
						var html = "<div class='clique' id="+this.cliques[i]+">";
						for (var j = 0; j < this.cliques[i].mots.length; j++) {
							html = html + this.cliques[i].mots[j].mot + ', ';
						}
						html = html + "</div>";
						$("#cliques").append(html);
						
					}
					if(this.clicked){
							this.clicked = false;
							this.text.visible=false;
							this.clearcliques();
						}else{
							this.clicked = true;
							this.text.visible = true;
							this.showcliques();
						}
						
				}.bind(this));

				this.showcliques = function(){
					/*
					reflechir à une belle solution pour montrer les cliques,
					*/
					for (var i = 0; i < this.cliques.length; i++) {
						let a = new paper.Path.Line(this.point, this.cliques[i].point);
						this.cliques[i].circle.visible = true;
						a.strokeColor = 'black';
						a.strokeWidth = 1/paper.view.zoom;
						this.paths.push(a);
					}
				}
				this.clearcliques = function(){
					for (var i = 0; i < this.paths.length; i++) {
						this.paths[i].remove();
					}
					this.paths = [];
					
						for (var i = 0; i < this.cliques.length; i++) {
							this.cliques[i].circle.visible = cliVisible;
						}
				}
				this.setAxis = function(x, y){
						this.point.x = 0.4*this.coords[x]*paper.view.bounds.width/extremevalues[x];
						this.point.y = 0.4*this.coords[y]*paper.view.bounds.height/extremevalues[y];
						this.circle.position = this.point;
						this.text.position = new paper.Point(this.point.x - 10/paper.view.zoom, this.point.y - 10/paper.view.zoom);
				}
				this.setAxis(0,1);
		}



		function Cli(clique, i){
				this.gray = new paper.Color(0.5);
				this.index = i;
				this.mots = cliques[i];
				for (var i = 0; i < this.mots.length; i++) {
					this.mots[i]= syns[this.mots[i] - 1];
				}
				this.clicked = false;
				this.coords = coords[this.index];
           		this.point = new paper.Point(0,0);


				this.circle = new paper.Path.Circle(this.point, 4);
           		this.circle.strokeWidth = 0;
           		this.circle.fillColor = this.gray;
				this.circle.onMouseEnter = function(event){
					
					if(!this.clicked){
					this.circle.fillColor = "black";
					for (var i = 0; i < this.mots.length; i++) {
						this.mots[i].linkPointText.visible = true;
						this.mots[i].text.fillColor = this.gray;
						this.mots[i].circle.fillColor = this.gray;
						this.mots[i].text.visible = true;
					}
					}
				}.bind(this);
				this.circle.onMouseLeave = function(event){
				if(!this.clicked){

					this.circle.fillColor = this.gray;
					for (var i = 0; i < this.mots.length; i++) {
						if(this.mots[i].clicked)
						{

							this.mots[i].text.fillColor = "green";
							this.mots[i].circle.fillColor = "green";
						}else{
							this.mots[i].linkPointText.visible = false;
							this.mots[i].text.visible = false;
							this.mots[i].text.fillColor = "magenta";
							this.mots[i].circle.fillColor = "magenta";
						}
					}
				}
				}.bind(this);
				this.circle.onClick = function(event){
					if(this.clicked){
						this.clicked = false;
						for (var i = 0; i < this.mots.length; i++) {
						this.mots[i].text.fillColor = this.gray;
						this.mots[i].circle.fillColor = this.gray;
						this.mots[i].text.visible = true;
						}
					}else{
						this.circle.fillColor = "black";
						this.clicked = true;
						for (var i = 0; i < this.mots.length; i++) {
								this.mots[i].text.fillColor = "black";
								this.mots[i].circle.fillColor = "black";
								this.mots[i].text.visible = true;
						}
					}
				}.bind(this);
				this.setAxis = function(x, y){
						this.point.x = 0.4*this.coords[x]*paper.view.bounds.width/extremevalues[x];
						this.point.y = 0.4*this.coords[y]*paper.view.bounds.height/extremevalues[y];
						this.circle.position = this.point;
				}
				this.setAxis(0,1);

		}

		function espsem(data, statut){
			
			data = JSON.parse(data);
			cliques = data.result.cliques;
			syns = data.result.synonymes;
			coords = data.result.coordonnees;
			getExtremsCoords();
			
			for (var i = 0; i < syns.length; i++) {
						syns[i] = new Syn(syns[i], i);
			}
			
			for (var i = 0; i < cliques.length; i++) {
						cliques[i] = new Cli(cliques[i], i);
			}
			
			for (var i = 0; i < syns.length; i++) {
				for (var j = 0; j < cliques.length; j++) {
           			for (var k = 0; k < cliques[j].mots.length; k++) {
           				if (cliques[j].mots[k]==syns[i]){
           					syns[i].cliques.push(cliques[j]);
           				}
           			}
           		}
			}
		}

		function getExtremsCoords(){
			for (var i = 0; i < 6; i++) {
				for (var j = 0; j < coords.length; j++) {
					if (Math.abs(coords[j][i])>extremevalues[i]){
						extremevalues[i] = Math.abs(coords[j][i]);
					}
				}
			}
		}
		
		paper.view.onFrame = function(event) {

		}
	}
    </script>
</body>
</html>


